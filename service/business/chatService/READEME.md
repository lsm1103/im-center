# 聊天业务的api服务（http）

## 聊天业务的接口设计

## 消息的防丢、消息必达
### 消息的防丢
- 分为单聊消息表、群聊消息表，在持久化层进行持久化存储，
涉及消息的业务都通过消息id进处理，然后在要发给前端时再统一进行批量消息内容查询；以此实现消息的防丢
### 消息必达
- 所有在线用户收到的消息，在一般情况下都可以送达到正确的用户客户端；
- 必达，确保用户一定收到了该消息
> 进行消息ack机制（http）
- 消息风暴问题
> 【定时/消息数阈值】触发批量ack
- 在线却未收到消息（因为网络、系统等原因）：
>* 创建用户消息seq表，记录用户单聊和群聊已ack消息的最大seq；设置一个上次seq字段，
可以触发去去检查当前最大seq和上次seq不连续的用户进行重试；同时客户端也要对自身不连续的消息进行同步
>* 因为一些原因未收到的消息可以在异步任务进行重试，重试间隔指数递增，最大24小时
- 离线用户未收到消息：
> TODO发送给客户端的消息体数据结构可能要变化；
>* 通过再次上线时客户端记录的最大seq来同步离线消息


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